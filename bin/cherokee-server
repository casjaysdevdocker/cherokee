#!/usr/bin/env sh
set -x
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
export PATH="/usr/local/share/cherokee/bin:$PATH"
[ -f "/config/ssl.env" ] && . "/config/ssl.env"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ ! -d "/config/cherokee" ] && [ -d "/usr/local/share/template-files/config/cherokee" ]; then
  mkdir -p "/config/cherokee"
  cp -Rf "/usr/local/share/template-files/config/cherokee/." "/config/cherokee/"
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
[ -d "/data/htdocs" ] || mkdir -p "/data/htdocs"
if [ -n "$(ls -A /data/htdocs/www/* 2>/dev/null||echo '')" ]; then
  mkdir -p "/data/htdocs" "/data/htdocs/cgi-bin"
  cp -Rf "/usr/local/share/template-files/data/." "/data/"
fi
[ -d "/usr/lib/cgi-bin" ] && [ -d "" ] && cp -Rf "/usr/lib/cgi-bin/." "/data/htdocs/cgi-bin/"
[ -f "/config/cherokee/cherokee.conf" ] && cp -Rfv "/config/cherokee/cherokee.conf" "/etc/cherokee/"
[ -d "/usr/local/share/cherokee/icons" ] && [ ! -d "/config/cherokee/icons" ] && cp -Rf "/usr/local/share/cherokee/icons/." "/config/cherokee/icons/"
[ -d "/usr/local/share/cherokee/themes" ] && [ ! -d "/config/cherokee/themes" ] && cp -Rf "/usr/local/share/cherokee/themes/." "/config/cherokee/themes/"
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ ! -f "/config/ssl//localhost.crt" ] || [ ! -f "/config/ssl//localhost.key" ]; then
  create-ssl-cert
fi
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
if [ ! -f "/tmp/cherokee.pid" ]; then
  cherokee-admin -b -p 19070 -c /config/cherokee.conf &
  exec cherokee -c /etc/cherokee/cherokee.conf || rm -Rf "/tmp/cherokee.pid"
fi

